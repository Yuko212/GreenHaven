<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenHaven</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Logo GreenHaven">
            <h1>GreenHaven</h1>
            <div class="icons">
                <a href="index.html"><img src="home-icon.png" alt="Home"></a>
                <a href="sensor.html"><img src="wifi-icon.png" alt="Sensores"></a>
                <a href="charts.html"><img src="chart-icon.png" alt="Gráficos"></a>
            </div>
        </div>
        
        <div class="status-box">
            <h2>Status <span class="status-indicator"></span></h2>
            <div class="buttons-container">
                <button id="btn-iluminacao" class="device-btn">Iluminação</button>
                <button id="btn-irrigacao" class="device-btn">Irrigação</button>
                <button id="btn-aquecimento" class="device-btn">Aquecimento</button>
                <button id="btn-ventilacao" class="device-btn">Ventilação</button>
            </div>
        </div>
        
        <div class="mode-toggle">
            <img src="auto-icon.png" alt="Modo Automático" class="mode-icon auto-icon">
            <label class="toggle-switch">
                <input type="checkbox" id="modeToggle" name="modeToggle">
                <span class="slider"></span>
            </label>
            <img src="manual-icon.png" alt="Modo Manual" class="mode-icon manual-icon">
            <span class="mode-status"></span>
        </div>
        
        <div class="sensor-container">
            <div class="sensor-panel">
                <h3>Monitoramento</h3>
                <div class="sensor-grid">
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="sun-icon.png" alt="Sol">
                            <span>Luminosidade</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 80%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="drop-icon.png" alt="Gota">
                            <span>Umidade</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="thermometer-icon.png" alt="Termômetro">
                            <span>Temperatura</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--°C</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0°C</span>
                                <span>Max: 0°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="water-level-icon.png" alt="Nível de Água">
                            <span>Nível de Água</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>GreenHaven &copy; 2024</p>
    </footer>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Navbar ---
            fetch('nav.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('nav-placeholder').innerHTML = data;
                });
        
            // Função para enviar requisições à API
            async function sendRequest(method, endpoint) {
                try {
                    const response = await fetch(endpoint, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    });
        
                    if (!response.ok) throw new Error('Erro na requisição: ' + response.statusText);
        
                    const data = await response.json();
                    console.log('Sucesso:', data);
                    alert('Operação realizada com sucesso!');
                    atualizarSensores();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao comunicar com a API: ' + error.message);
                }
            }
        
            // Atualizar sensores
            async function atualizarSensores() {
                try {
                    const response = await fetch('/api/sensores');
                    const data = await response.json();
                    document.querySelector('.current-value').textContent = data.luminosidade + '%';
                } catch (error) {
                    console.error('Erro ao buscar sensores:', error);
                }
            }
        
            // Testar API
            async function testarApi() {
                try {
                    const response = await fetch('/api/sensores');
                    const data = await response.json();
                    console.log('Dados recebidos:', data);
                } catch (error) {
                    console.error('Erro ao testar API:', error);
                }
            }
        
            // --- Controle do Switch ---
            const modeToggle = document.getElementById('modeToggle');
            const modeStatus = document.querySelector('.mode-status');

            // Carregar valor inicial do backend
            async function carregarModo() {
                try {
                    const response = await fetch('http://localhost:88/GreenHaven/aula3004/api/switch', { method: 'GET' });
                    const data = await response.json();
                    console.log("Carregar modo:", data);

                    // Atualiza toggle e texto imediatamente
                    if (data.atividade === 1) {
                        modeToggle.checked = true;
                        modeStatus.textContent = "Modo Manual";
                    } else {
                        modeToggle.checked = false;
                        modeStatus.textContent = "Modo Automático";
                    }

                    // Atualiza os botões depois de carregar o modo
                    atualizarBotoesVisual();

                } catch (error) {
                    console.error("Erro ao carregar modo:", error);
                    modeToggle.checked = false;
                    modeStatus.textContent = "Modo Automático";
                    atualizarBotoesVisual();
                }
            }

            // Atualizar valor no backend (não muda o texto aqui)
            async function atualizarModo(atividade) {
                try {
                    const response = await fetch('http://localhost:88/GreenHaven/aula3004/api/switch', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ atividade })
                    });
                    const data = await response.json();
                    console.log("Resposta PUT:", data);
                } catch (error) {
                    console.error("Erro ao atualizar modo:", error);
                }
            }

            // Listener do toggle
            modeToggle.addEventListener('change', () => {
                const manual = modeToggle.checked;

                // Atualiza texto imediatamente
                modeStatus.textContent = manual ? "Modo Automático" : "Modo Manual";

                // Atualiza backend
                atualizarModo(manual ? 1 : 0);

                // Atualiza botões visuais
                atualizarBotoesVisual();
            });

            // --- FUNÇÃO DE CONTROLE DOS ATUADORES ---
                    const atuadores = [
                { id: 1, btnId: 'btn-iluminacao' },
                { id: 2, btnId: 'btn-irrigacao' },
                { id: 3, btnId: 'btn-aquecimento' },
                { id: 4, btnId: 'btn-ventilacao' },
            ];

            async function atualizarBotao(atuador) {
                try {
                    const res = await fetch(`http://localhost:88/GreenHaven/aula3004/api/atuador/${atuador.id}`, { method: 'GET' });
                    const data = await res.json();
                    const ligado = data.status === 1 && modeToggle.checked;
                    atuador.btn.classList.toggle('active', ligado);
                    atuador.btn.disabled = !modeToggle.checked;
                } catch (err) {
                    console.error(`Erro ao carregar status do atuador ${atuador.id}:`, err);
                }
            }

                atuadores.forEach(atuador => {
                    const btn = document.getElementById(atuador.btnId);
                    if (!btn) return console.error(`Botão ${atuador.btnId} não encontrado!`);
                    atuador.btn = btn;

                    btn.addEventListener('click', async () => {
                        if (!modeToggle.checked) return;
                        console.log(`Clique no atuador ${atuador.id}`);
                        try {
                            const res = await fetch(`http://localhost:88/GreenHaven/aula3004/api/atuador/${atuador.id}`, {
                                method: 'PUT'
                            });
                            const data = await res.json();
                            console.log("Resposta atuador:", data);
                            btn.classList.toggle('active', data.status === 1 && modeToggle.checked);
                        } catch (err) {
                            console.error(`Erro ao alternar atuador ${atuador.id}:`, err);
                        }
                    });
                });

            // Atualiza todos os botões ao carregar
            function atualizarBotoesVisual() {
                atuadores.forEach(at => atualizarBotao(at));
            }

            // Inicializa estado
            carregarModo();
        });
        </script>
        

    <script src="updateSensors.js" type="module"></script>
</body>
</html>
