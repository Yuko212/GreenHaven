<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenHaven</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Logo GreenHaven">
            <h1>GreenHaven</h1>
            <div class="icons">
                <a href="index.html"><img src="home-icon.png" alt="Home"></a>
                <a href="sensor.html"><img src="wifi-icon.png" alt="Sensores"></a>
                <a href="charts.html"><img src="chart-icon.png" alt="Gráficos"></a>
            </div>
        </div>
        
        <div class="status-box">
            <h2>Status <span class="status-indicator"></span></h2>
            <div class="buttons-container">
                <button class="device-btn">Ligar Iluminação</button>
                <button class="device-btn">Ligar Irrigação</button>
                <button class="device-btn">Ligar Aquecimento</button>
                <button class="device-btn">Ligar Ventilação</button>
            </div>
        </div>
        
        <div class="mode-toggle">
            <img src="auto-icon.png" alt="Modo Automático" class="mode-icon auto-icon">
            <label class="toggle-switch">
                <input type="checkbox" id="modeToggle" name="modeToggle">
                <span class="slider"></span>
            </label>
            <img src="manual-icon.png" alt="Modo Manual" class="mode-icon manual-icon">
            <span class="mode-status"></span>
        </div>
        
        <div class="sensor-container">
            <div class="sensor-panel">
                <h3>Monitoramento</h3>
                <div class="sensor-grid">
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="sun-icon.png" alt="Sol">
                            <span>Luminosidade</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 80%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="drop-icon.png" alt="Gota">
                            <span>Umidade</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="thermometer-icon.png" alt="Termômetro">
                            <span>Temperatura</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--°C</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0°C</span>
                                <span>Max: 0°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <img src="water-level-icon.png" alt="Nível de Água">
                            <span>Nível de Água</span>
                        </div>
                        <div class="sensor-values">
                            <div class="sensor-value">
                                <span>Atual:</span>
                                <span class="current-value">--%</span>
                            </div>
                            <div class="sensor-range">
                                <span>Min: 0%</span>
                                <span>Max: 0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>GreenHaven &copy; 2024</p>
    </footer>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Navbar ---
            fetch('nav.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('nav-placeholder').innerHTML = data;
                });

            // Função para enviar requisições à API
            async function sendRequest(method, endpoint) {
                try {
                    const response = await fetch(endpoint, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) throw new Error('Erro na requisição: ' + response.statusText);

                    const data = await response.json();
                    console.log('Sucesso:', data);
                    alert('Operação realizada com sucesso!');
                    atualizarSensores();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao comunicar com a API: ' + error.message);
                }
            }

            // Funções para os botões
            function ligarIluminacao() { sendRequest('PUT', '/api/iluminacao'); }
            function ligarIrrigacao() { sendRequest('PUT', '/api/irrigacao'); }
            function ligarAquecimento() { sendRequest('PUT', '/api/aquecimento'); }
            function ligarVentilacao() { sendRequest('PUT', '/api/ventilacao'); }

            // Atualizar sensores
            async function atualizarSensores() {
                try {
                    const response = await fetch('/api/sensores');
                    const data = await response.json();
                    document.querySelector('.current-value').textContent = data.luminosidade + '%';
                } catch (error) {
                    console.error('Erro ao buscar sensores:', error);
                }
            }

            // Testar API
            async function testarApi() {
                try {
                    const response = await fetch('/api/sensores');
                    const data = await response.json();
                    console.log('Dados recebidos:', data);
                } catch (error) {
                    console.error('Erro ao testar API:', error);
                }
            }

            // Eventos botões
            const buttons = document.querySelectorAll('.device-btn');
            buttons[0].addEventListener('click', ligarIluminacao);
            buttons[1].addEventListener('click', ligarIrrigacao);
            buttons[2].addEventListener('click', ligarAquecimento);
            buttons[3].addEventListener('click', ligarVentilacao);
            testarApi();

            // --- Controle do Switch ---
            const modeToggle = document.getElementById('modeToggle');
            const modeStatus = document.querySelector('.mode-status');

            // Carregar valor inicial do backend
            async function carregarModo() {
                try {
                    const response = await fetch('http://localhost:88/GreenHaven/aula3004/api/switch', { method: 'GET' });
                    const data = await response.json();
                    console.log("Carregar modo:", data);

                    if (data.atividade === 1) {
                        modeToggle.checked = true;
                        modeStatus.textContent = "Modo Automático";
                    } else {
                        modeToggle.checked = false;
                        modeStatus.textContent = "Modo Manual";
                    }
                } catch (error) {
                    console.error("Erro ao carregar modo:", error);
                    modeToggle.checked = false;
                    modeStatus.textContent = "Modo Automático";
                }
            }

            // Atualizar valor no backend
            async function atualizarModo(atividade) {
                try {
                    const response = await fetch('http://localhost:88/GreenHaven/aula3004/api/switch', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ atividade })
                    });
                    const data = await response.json();
                    modeStatus.textContent = (data.atividade === 1) ? "Modo Manual" : "Modo Automático";
                    console.log("Resposta PUT:", data);
                } catch (error) {
                    console.error("Erro ao atualizar modo:", error);
                }
            }

            // Listener do toggle
            modeToggle.addEventListener('change', () => {
                const atividade = modeToggle.checked ? 1 : 0;
                console.log("Mudou! Novo valor:", atividade);
                atualizarModo(atividade);
            });

            // Inicializa estado
            carregarModo();
        });
    </script>

    <script src="updateSensors.js" type="module"></script>
</body>
</html>
